#include <HardwareSerial.h>
#include <usb_seremu.h>
#include <usb_serial.h>
#include "SoilSensor.h"

uint16_t modbusCRC(uint8_t *buf, int len, uint8_t RS485_DIR_PIN, uint8_t SLAVE_ID, HardwareSerial &modbus) {
  uint16_t crc = 0xFFFF;
  for (int pos = 0; pos < len; pos++) {
    crc ^= (uint16_t)buf[pos];
    for (int i = 8; i != 0; i--) {
      if (crc & 0x0001) {
        crc >>= 1;
        crc ^= 0xA001;
      } else {
        crc >>= 1;
      }
    }
  }
  return crc;
}

void sendReadHoldingRegisters(uint16_t reg, uint8_t RS485_DIR_PIN, uint8_t SLAVE_ID, HardwareSerial &modbus) {
  uint8_t frame[8];

  frame[0] = SLAVE_ID;
  frame[1] = 0x03;
  frame[2] = reg >> 8;
  frame[3] = reg & 0xFF;
  frame[4] = 0x00;
  frame[5] = 0x01;   // read 1 register

  uint16_t crc = modbusCRC(frame, 6, RS485_DIR_PIN, SLAVE_ID, modbus);
  frame[6] = crc & 0xFF;
  frame[7] = crc >> 8;

  digitalWrite(RS485_DIR_PIN, HIGH);
  delayMicroseconds(10);
  modbus.write(frame, 8);
  modbus.flush();
  delayMicroseconds(10);
  digitalWrite(RS485_DIR_PIN, LOW);
}

bool readRegister(uint16_t reg, float32_t &value, uint8_t RS485_DIR_PIN, uint8_t SLAVE_ID, HardwareSerial &modbus) {
  uint8_t rx[7];
  int idx = 0;
  unsigned long start = millis();

  sendReadHoldingRegisters(reg, RS485_DIR_PIN, SLAVE_ID, modbus);

  while (millis() - start < 200) {
    if (modbus.available()) {
      rx[idx++] = modbus.read();
      if (idx >= 7) break;
    }
  }

  if (idx != 7) return false;

  uint16_t crcCalc = modbusCRC(rx, 5, RS485_DIR_PIN, SLAVE_ID, modbus);
  uint16_t crcRecv = rx[5] | (rx[6] << 8);
  if (crcCalc != crcRecv) return false;

  value = (rx[3] << 8) | rx[4];
  return true;
}

// void setup() {
//   Serial.begin(115200);
//   modbus.begin(9600, SERIAL_8N1);

//   pinMode(RS485_DIR_PIN, OUTPUT);
//   digitalWrite(RS485_DIR_PIN, LOW);

//   Serial.println("Soil sensor Modbus reader started");
// }

// void loop() {
//   uint16_t raw;

//   if (readRegister(0x0006, raw))
//     Serial.printf("pH: %.2f\n", raw / 100.0);

//   if (readRegister(0x0012, raw))
//     Serial.printf("Soil Humidity: %.1f %%RH\n", raw / 10.0);

//   if (readRegister(0x0013, raw))
//     Serial.printf("Soil Temperature: %.1f C\n", raw / 10.0);

//   if (readRegister(0x0015, raw))
//     Serial.printf("Conductivity: %u uS/cm\n", raw);

//   if (readRegister(0x001E, raw))
//     Serial.printf("Nitrogen: %u mg/kg\n", raw);

//   if (readRegister(0x001F, raw))
//     Serial.printf("Phosphorus: %u mg/kg\n", raw);

//   if (readRegister(0x0020, raw))
//     Serial.printf("Potassium: %u mg/kg\n", raw);

//   Serial.println("----------------------------");
//   delay(3000);
// }